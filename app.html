<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Iris Mapper Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="shortcut icon" href="/favicon.ico">
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.3/purify.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase Configuration and Auth Check -->
    <script src="js/firebase-config.js"></script>
    <script src="js/auth-check.js"></script>
</head>
<body>
    <div class="app-container">
        <div class="logo-container">
            <img src="grids/watermark.png" alt="Logo" class="logo">
            <span class="version-text">v5.1</span>
        </div>

        <!-- Profile Container -->
        <div class="profile-container">
            <div class="profile-icon" id="profileIcon">
                üë§
            </div>
            <div class="profile-dropdown" id="profileDropdown">
                <div class="profile-header">
                    <span class="user-email" id="userEmail">Loading...</span>
                </div>
                <div class="profile-menu">
                    <div class="profile-menu-item" id="accountSettings">
                        <span class="menu-icon">‚öôÔ∏è</span>
                        <span class="menu-text">Account Settings</span>
                    </div>
                    <div class="profile-menu-item" id="manageSubscription">
                        <span class="menu-icon">üí≥</span>
                        <span class="menu-text">Manage Subscription</span>
                    </div>
                    <div class="profile-menu-item" id="changePassword">
                        <span class="menu-icon">üîë</span>
                        <span class="menu-text">Change Password</span>
                    </div>
                    <div class="profile-menu-divider"></div>
                    <div class="profile-menu-item logout-item" id="logoutBtn">
                        <span class="menu-icon">üö™</span>
                        <span class="menu-text">Logout</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls eye-selection-panel">
            <button class="btn" id="leftEye">L</button>
            <button class="btn" id="rightEye">R</button>
            <button class="btn" id="bothEyes" disabled>L+R</button>
        </div>

        <div id="single-mapper-container" class="iris-container">
            <div id="svg-container"></div>
            <div id="image-container"></div>
        </div>

        <div id="dual-mapper-container" style="display: none;">
            <div class="eye-container">
                <div id="left-svg-container"></div>
                <div id="left-image-container"></div>
            </div>
            <div class="eye-container">
                <div id="right-svg-container"></div>
                <div id="right-image-container"></div>
            </div>
        </div>

<!-- Top-Left Controls -->
<div class="controls top-left" id="menuContainer">
    <input type="file" id="imageUpload" accept="image/*" multiple style="display:none;">
    <button class="btn" onclick="document.getElementById('imageUpload').click()">Upload Image(s)</button>
    <button class="btn" id="selectMap">Select Map</button>
    <button class="btn" id="customMap">Custom Map</button>
    
    <div class="zoom-controls">
        <button class="btn zoom-btn" id="zoomIn">Zoom +</button>
        <button class="btn zoom-btn" id="zoomOut">Zoom -</button>
    </div>
    
    <div class="rotation-buttons">
        <button class="btn" id="rotateLeft">‚Ü∫</button>
        <button class="btn" id="rotateRight">‚Üª</button>
    </div>
    
    <div class="direction-buttons">
        <button class="btn" id="moveUp">‚Üë</button>
        <button class="btn" id="moveLeft">‚Üê</button>
        <button class="btn" id="moveRight">‚Üí</button>
        <button class="btn" id="moveDown">‚Üì</button>
    </div>
</div>

        <div class="controls bottom-left">
            <input type="range" id="opacitySlider" min="0" max="1" step="0.01" value="0.7">
            <input type="color" id="mapColor" value="#000000">
            <button class="btn" id="notes">Notes</button>
            <button class="btn" id="save">Save</button>
            <button class="btn" id="saveToAccount">Save to Account</button>
        </div>

        <div class="controls bottom-right">
            <!-- Saved Projects Section -->
            <div class="saved-projects" id="savedProjects" style="display: none;">
                <div class="saved-projects-header">
                    <h3>My Saved Projects</h3>
                    <button class="refresh-btn" id="refreshSavedProjects">‚Üª</button>
                </div>
                <div class="saved-projects-list" id="savedProjectsList">
                    <!-- Saved projects will be loaded here -->
                </div>
            </div>
            
            <!-- Current Session Gallery -->
            <div class="gallery">
                <div class="gallery-header">
                    <h3>Session Gallery</h3>
                    <button class="add-image-btn">+</button>
                </div>
                <div class="gallery-accordion" id="galleryAccordion">
                </div>
            </div>

            <div class="image-adjustments">
                <div class="histogram">
                    <canvas id="histogramCanvas"></canvas>
                </div>
                <button class="auto-levels" id="autoLevels">Auto Levels</button>
                <button class="reset-button" id="resetAdjustments">Reset</button>
                
                <div class="adjustment-group">
                    <div class="adjustment-row">
                        <span class="adjustment-label">Exposure</span>
                        <input type="range" class="adjustment-slider" id="exposureSlider" min="-100" max="100" value="0">
                        <span class="adjustment-value">0</span>
                    </div>
                    <div class="adjustment-row">
                        <span class="adjustment-label">Contrast</span>
                        <input type="range" class="adjustment-slider" id="contrastSlider" min="-100" max="100" value="0">
                        <span class="adjustment-value">0</span>
                    </div>
                    <div class="adjustment-row">
                        <span class="adjustment-label">Saturation</span>
                        <input type="range" class="adjustment-slider" id="saturationSlider" min="-100" max="100" value="0">
                        <span class="adjustment-value">0</span>
                    </div>
                    <div class="adjustment-row">
                        <span class="adjustment-label">Hue</span>
                        <input type="range" class="adjustment-slider" id="hueSlider" min="-180" max="180" value="0">
                        <span class="adjustment-value">0</span>
                    </div>
                    <div class="adjustment-row">
                        <span class="adjustment-label">Shadows</span>
                        <input type="range" class="adjustment-slider" id="shadowsSlider" min="-100" max="100" value="0">
                        <span class="adjustment-value">0</span>
                    </div>
                    <div class="adjustment-row">
                        <span class="adjustment-label">Highlights</span>
                        <input type="range" class="adjustment-slider" id="highlightsSlider" min="-100" max="100" value="0">
                        <span class="adjustment-value">0</span>
                    </div>
                    <div class="adjustment-row">
                        <span class="adjustment-label">Temperature</span>
                        <input type="range" class="adjustment-slider" id="temperatureSlider" min="-100" max="100" value="0">
                        <span class="adjustment-value">0</span>
                    </div>
                    <div class="adjustment-row">
                        <span class="adjustment-label">Sharpness</span>
                        <input type="range" class="adjustment-slider" id="sharpnessSlider" min="0" max="100" value="0">
                        <span class="adjustment-value">0</span>
                    </div>
                </div>
                
                </div>
            </div>
        </div>

        <div class="progress-indicator" id="progressIndicator">
            <div class="spinner"></div>
        </div>
    </div>

    <div id="mapModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Select a Map</h2>
            <div id="mapOptions" class="map-options"></div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div id="notesModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" id="closeNotesModal">&times;</span>
            <h2>Notes for Current Image</h2>
            <textarea id="notesInput" rows="10" cols="50" placeholder="Enter your notes here..."></textarea>
            <div id="savedNotesArea"></div>
            <button class="btn" id="saveNoteBtn">Save Note</button>
        </div>
    </div>

    <!-- Web Worker Script -->
    <script id="workerScript" type="javascript/worker">
        self.addEventListener('message', function(e) {
            const imageData = e.data;
            const histogramData = calculateHistogram(imageData);
            self.postMessage(histogramData);
        });

        function calculateHistogram(imageData) {
            const data = imageData.data;
            const length = data.length;
            const histogramR = new Uint32Array(256);
            const histogramG = new Uint32Array(256);
            const histogramB = new Uint32Array(256);

            for (let i = 0; i < length; i += 4) {
                histogramR[data[i]]++;
                histogramG[data[i + 1]]++;
                histogramB[data[i + 2]]++;
            }

            return { histogramR, histogramG, histogramB };
        }
    </script>

    <!-- Storage Manager -->
    <script src="js/storage-manager.js"></script>
    
    <!-- Subscription Gate -->
    <script src="js/auth-redirect.js"></script>
    
    <!-- Profile Dropdown Functionality -->
    <script>
        // Profile Dropdown Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const profileIcon = document.getElementById('profileIcon');
            const profileDropdown = document.getElementById('profileDropdown');
            const userEmailElement = document.getElementById('userEmail');
            const logoutBtn = document.getElementById('logoutBtn');
            const manageSubscription = document.getElementById('manageSubscription');
            const changePassword = document.getElementById('changePassword');
            const accountSettings = document.getElementById('accountSettings');
            
            // Check authentication and update profile
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    // User is signed in - update email display
                    userEmailElement.textContent = user.email || 'User';
                    console.log('User authenticated:', user.email);
                } else {
                    // No user signed in - redirect to login
                    console.log('No user authenticated, redirecting to login');
                    window.location.href = '/login';
                }
            });
            
            // Toggle dropdown on profile icon click
            profileIcon.addEventListener('click', function(e) {
                e.stopPropagation();
                profileDropdown.classList.toggle('show');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!profileDropdown.contains(e.target) && !profileIcon.contains(e.target)) {
                    profileDropdown.classList.remove('show');
                }
            });
            
            // Logout functionality
            logoutBtn.addEventListener('click', async function() {
                try {
                    await firebase.auth().signOut();
                    console.log('User logged out successfully');
                    window.location.href = '/login';
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Error logging out. Please try again.');
                }
            });
            
            // Manage Subscription - Opens Stripe Customer Portal
            manageSubscription.addEventListener('click', async function() {
                try {
                    profileDropdown.classList.remove('show');
                    
                    // Get current user
                    const user = firebase.auth().currentUser;
                    if (!user) {
                        window.location.href = '/login';
                        return;
                    }
                    
                    // Show loading state
                    manageSubscription.style.opacity = '0.5';
                    manageSubscription.style.pointerEvents = 'none';
                    
                    // Create a portal session via Netlify function
                    const response = await fetch('/.netlify/functions/create-portal-session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            email: user.email 
                        })
                    });
                    
                    // Reset button state
                    manageSubscription.style.opacity = '1';
                    manageSubscription.style.pointerEvents = 'auto';
                    
                    if (!response.ok) {
                        console.error('Portal session response not ok:', response.status);
                        // For now, redirect to pricing page as fallback
                        if (confirm('Would you like to view subscription options?')) {
                            window.location.href = '/pricing';
                        }
                        return;
                    }
                    
                    const data = await response.json();
                    
                    if (data.url) {
                        // Redirect to Stripe Customer Portal
                        window.location.href = data.url;
                    } else {
                        // Fallback to pricing page
                        if (confirm('Unable to access portal. View subscription options?')) {
                            window.location.href = '/pricing';
                        }
                    }
                } catch (error) {
                    console.error('Error accessing subscription portal:', error);
                    // Fallback to pricing page
                    if (confirm('Error accessing portal. View subscription options?')) {
                        window.location.href = '/pricing';
                    }
                }
            });
            
            // Change Password functionality
            changePassword.addEventListener('click', async function() {
                try {
                    profileDropdown.classList.remove('show');
                    
                    const user = firebase.auth().currentUser;
                    if (user && user.email) {
                        // Send password reset email
                        await firebase.auth().sendPasswordResetEmail(user.email);
                        alert(`Password reset email sent to ${user.email}. Please check your inbox.`);
                    } else {
                        alert('Unable to send password reset email. Please try again.');
                    }
                } catch (error) {
                    console.error('Error sending password reset:', error);
                    alert('Error sending password reset email. Please try again.');
                }
            });
            
            // Account Settings (placeholder for now)
            accountSettings.addEventListener('click', function() {
                profileDropdown.classList.remove('show');
                alert('Account settings page coming soon!');
                // In the future, this could navigate to a dedicated settings page
                // window.location.href = '/settings';
            });
            
            // Prevent dropdown from closing when clicking inside it
            profileDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });
    </script>
    
    <!-- Main JavaScript -->
    <script src="script.js"></script>
</body>
</html>

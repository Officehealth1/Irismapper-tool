<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Welcome to Iris Mapper Pro!</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@300;400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Josefin Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1c262f;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #ffffff;
            line-height: 1.6;
        }
        
        .success-container {
            background: white;
            border-radius: 12px;
            padding: 50px 40px;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }
        
        .checkmark {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #0dc5a1;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: scaleIn 0.5s ease-out;
        }
        
        @keyframes scaleIn {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .checkmark::after {
            content: 'âœ“';
            color: white;
            font-size: 48px;
            font-weight: bold;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2rem;
        }
        
        .message {
            color: #666;
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        
        .trial-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .trial-info h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .trial-info p {
            color: #666;
            font-size: 0.95rem;
        }
        
        .cta-button {
            display: inline-block;
            padding: 15px 40px;
            background: #0dc5a1;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        
        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(13, 197, 161, 0.4);
            background: #0ba085;
        }
        
        .next-steps {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e0e0e0;
        }
        
        .next-steps h3 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .steps-list {
            text-align: left;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .steps-list li {
            color: #666;
            margin-bottom: 10px;
            padding-left: 25px;
            position: relative;
        }
        
        .steps-list li::before {
            content: 'â†’';
            position: absolute;
            left: 0;
            color: #0dc5a1;
        }
        
        /* Auto-login status styling */
        .login-status {
            background: #0dc5a1;
            border-radius: 10px;
            padding: 15px 20px;
            margin: 25px 0;
            animation: slideIn 0.5s ease;
        }
        
        .status-message {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: white;
            font-weight: 500;
        }
        
        .spinner-small {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Email notice styling */
        .email-notice {
            background: rgba(13, 197, 161, 0.1);
            border: 1px solid #0dc5a1;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            animation: slideIn 0.5s ease;
        }
        
        .email-notice p {
            color: #333;
            margin: 5px 0;
            font-size: 0.95rem;
        }
        
        .email-notice strong {
            color: #0dc5a1;
            font-weight: 600;
        }
        
        .email-notice .small-text {
            font-size: 0.85rem;
            color: #666;
            margin-top: 8px;
        }
        
        /* Success state for login status */
        .login-status.success {
            background: #0dc5a1;
        }
        
        /* Error state for login status */
        .login-status.info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        
        .login-status.info .status-message {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="success-container">
        <div class="checkmark"></div>
        
        <h1>Welcome to Iris Mapper Pro!</h1>
        
        <p class="message">
            ðŸŽ‰ Fantastic! Your subscription is active and ready to go.
            We're thrilled to have you join the Iris Mapper Pro community!
        </p>
        
        <div class="trial-info">
            <h3>âœ¨ Your 14-Day Trial Has Started</h3>
            <p>Explore all premium features completely free. No charges until after your trial ends.</p>
            <p><strong>Trial ends on: <span id="trial-end-date"></span></strong></p>
        </div>
        
        <!-- Auto-login status message -->
        <div id="loginStatus" class="login-status" style="display: none;">
            <div class="status-message">
                <span class="spinner-small"></span>
                <span id="statusText">Setting up your account...</span>
            </div>
        </div>
        
        <a href="#" class="cta-button" id="startUsingBtn">Start Using Iris Mapper Pro</a>
        
        
        <div class="next-steps">
            <h3>What's Next?</h3>
            <ul class="steps-list">
                <li>Upload your first iris image</li>
                <li>Select an iris mapping template</li>
                <li>Adjust and analyze the image</li>
                <li>Save or export your work</li>
                <li>Manage your subscription in Account Settings</li>
            </ul>
        </div>
    </div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="js/firebase-config.js"></script>
    
    <script>
        // Calculate and display trial end date
        const trialEndDate = new Date();
        trialEndDate.setDate(trialEndDate.getDate() + 14);
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('trial-end-date').textContent = 
            trialEndDate.toLocaleDateString('en-GB', options);
        
        // Get user email from URL parameters (passed from Stripe)
        const urlParams = new URLSearchParams(window.location.search);
        const userEmail = urlParams.get('email') || localStorage.getItem('userEmail');
        
        // UI elements
        const loginStatus = document.getElementById('loginStatus');
        const statusText = document.getElementById('statusText');
        const startBtn = document.getElementById('startUsingBtn');
        
        // Handle "Start Using" button click
        startBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            
            // Show friendly loading status
            loginStatus.style.display = 'block';
            statusText.textContent = 'âœ¨ Getting everything ready for you...';
            startBtn.textContent = 'One moment please...';
            startBtn.style.opacity = '0.7';
            startBtn.style.pointerEvents = 'none';
            
            // Small delay for better UX
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            try {
                if (userEmail) {
                    statusText.textContent = 'ðŸ” Signing you in securely...';
                    
                    // Start both auto-login and welcome email in parallel
                    const [autoLoginResponse, welcomeEmailResponse] = await Promise.all([
                        // Auto-login attempt
                        fetch('/.netlify/functions/create-auto-login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: userEmail })
                        }),
                        // Send welcome email for password setup
                        fetch('/.netlify/functions/send-welcome-email', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: userEmail })
                        })
                    ]);
                    
                    const data = await autoLoginResponse.json();
                    const welcomeResult = await welcomeEmailResponse.json();
                    
                    if (data.success && data.customToken) {
                        // Sign in with custom token
                        await firebase.auth().signInWithCustomToken(data.customToken);
                        
                        // Success feedback with welcome email info
                        loginStatus.classList.add('success');
                        if (welcomeResult.success) {
                            statusText.textContent = 'âœ… Perfect! Welcome email sent & taking you to your dashboard...';
                        } else {
                            statusText.textContent = 'âœ… Perfect! Taking you to your dashboard...';
                            console.log('Welcome email failed but auto-login succeeded');
                        }
                        
                        // Clear stored email
                        localStorage.removeItem('userEmail');
                        
                        // Short delay for user to see success message
                        await new Promise(resolve => setTimeout(resolve, 1500));
                        
                        // Redirect to app
                        window.location.href = '/app';
                        return;
                    }
                }
                
                // If auto-login not available, show helpful message with welcome email info
                loginStatus.classList.add('info');
                if (welcomeResult && welcomeResult.success) {
                    statusText.innerHTML = 'ðŸ“§ Welcome email sent! Check your inbox to set up your password';
                } else {
                    statusText.innerHTML = 'ðŸ“§ Please check your email for login instructions';
                }
                startBtn.textContent = 'Go to Login Page';
                startBtn.style.opacity = '1';
                startBtn.style.pointerEvents = 'auto';
                
                // Update button to go to login
                startBtn.onclick = () => {
                    window.location.href = '/login';
                };
                
            } catch (error) {
                console.error('Auto-login error:', error);
                
                // Show friendly error message (welcome email may still have been sent)
                loginStatus.classList.add('info');
                statusText.innerHTML = 'ðŸ“§ Welcome email sent! Check your inbox to set up your password';
                startBtn.textContent = 'Go to Login Page';
                startBtn.style.opacity = '1';
                startBtn.style.pointerEvents = 'auto';
                
                // Update button to go to login
                startBtn.onclick = () => {
                    window.location.href = '/login';
                };
            }
        });
        
        // Store email for potential future use
        if (userEmail) {
            localStorage.setItem('userEmail', userEmail);
        }
    </script>
</body>
</html>